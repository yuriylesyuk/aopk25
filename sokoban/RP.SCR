( introduction                                       03/25/91 ) ( +- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -+     |                                                         |     |    реализация игрушки Soko-ban предследует учебные      |     |       цели и акцентирует внимание на критичных          |     |         к процессу программирования местах              |     |                                                         |     |                                                         |     |                                                         |     |                      программа продолжает славную       |     |                      серию реализаций игрушки Soko-ban  |     |                      на различных языках программиро-   |     |                      вания от Insight corp.,            |     |                      представляя Forth                  |     |                                                         |     + -- -- -- -- -- -- -- -- -- -- (c) Insight corp., 1991 --+ ) ( слова для ввода клавиши и позиционирования курсора 01/04/80 )                                                                                                                                 256  CONSTANT F_key ( системная константа -                                           смещение для скан-кодов )                 : GETKEY ( --- n )  ( системный ввод )                            KEY                                                             DUP 0= IF DROP KEY F_key + THEN                               ;                                                                                                                               : GOTO_XY ( x y --- )                                             SWAP 2 * SWAP GOTOXY ;                                                                                                        : BELL ( --- ) 7 EMIT ; ( выдача звукового сигнала на консоль )                                                                 -->                                                             ( определение констант                               01/04/80 ) HEX                                                               ( коды клавиш управления )  1B   CONSTANT F_esc                                             20   CONSTANT F_restart           F_key 4B + CONSTANT F_Left    F_key 4D + CONSTANT F_Right       F_key 48 + CONSTANT F_Up      F_key 50 + CONSTANT F_Down                                                                        80   CONSTANT C_ctrl_bit                                        7F   CONSTANT C_bit_mask                                                   ( --- коды спрайтов игрушки --- )                    0  DUP CONSTANT S_fre_plc     C_ctrl_bit + CONSTANT Sb_fre_plc  1  DUP CONSTANT S_man         C_ctrl_bit + CONSTANT Sb_man      9  DUP CONSTANT S_wall        C_ctrl_bit + CONSTANT Sb_wall     4  DUP CONSTANT S_box         C_ctrl_bit + CONSTANT Sb_box      DECIMAL                                                         -->                                                             ( игрушечные переменные                              03/23/91 )                                                                   VARIABLE MAN_X   0 MAN_X !                                      VARIABLE MAN_Y   0 MAN_Y !                                                                                                      VARIABLE SCORE_ALL 0 SCORE_ALL ! ( максимальн.кол-во очков )    VARIABLE SCORE_NEW 0 SCORE_NEW ! ( текущее кол-во очков    )                                                                  : SCORE_ALL++ ( --- ) SCORE_ALL @ 1 + SCORE_ALL ! ;             : SCORE_ALL-- ( --- ) SCORE_ALL @ 1 - SCORE_ALL ! ;             : SCORE_NEW++ ( --- ) SCORE_NEW @ 1 + SCORE_NEW ! ;             : SCORE_NEW-- ( --- ) SCORE_NEW @ 1 - SCORE_NEW ! ;                                                                               VARIABLE KBRD_KEY  ( введенный с калвиатуры символ )                                                                          -->                                                             ( определение типа ARRAY и определение поля игры     03/22/91 ) 30 CONSTANT GF_col                                              20 CONSTANT GF_row                                              : ARRAY ( #col #row --- )                                               SWAP CREATE OVER , * ALLOT                                DOES> ( #col #row --- A )                                             DUP @ ROT * + + 2+ ;                                                                                                    GF_row GF_col ARRAY GF                                                                                                          : GF@ ( #col #row --- n ) GF C@ ;                               : GF! ( n #col #row --- ) GF C! ;                               : .GF ( \ cod-line ( #col #row --- )                              GF ASCII # WORD COUNT ROT SWAP CMOVE> ;                                                                                       -->                                                             ( инициализация игровой ситуации                     03/22/91 ) : GF_CLEAR ( -- ) GF_row 0 DO GF_col 0 DO 0 I J GF! LOOP LOOP ; GF_CLEAR                                                        0  1 .GF 00000009999900000000000000000000#                      0  2 .GF 00000009000900000000000000000000#                      0  3 .GF 00000009000900000000000000000000#                      0  4 .GF 00000009400900000000000000000000#                      0  5 .GF 00000999004999000000000000000000#                      0  6 .GF 00000900400409000000000000000000#                      0  7 .GF 00099909099909000009999990000000#                      0  8 .GF 00090009099909999999003390000000#                      0  9 .GF 00090400400000000000003390000000#                      0 10 .GF 00099999099990919999003390000000#                      0 11 .GF 00000009000000999009999990000000#                      0 12 .GF 00000009999999900000000000000000#                      -->                                                             ( конвертер внешнего представления игры в внутреннее 03/23/91 )                                                                 : GF_CONVERT ( --- )                                              GF_row 0 DO GF_col 0 DO I J GF@ CASE                                   ASCII 0 OF S_fre_plc  ENDOF                                     ASCII 9 OF S_wall     ENDOF                                     ASCII 4 OF S_box      ENDOF                                     ASCII 3 OF Sb_fre_plc SCORE_ALL++ ENDOF                         ASCII 7 OF Sb_box SCORE_NEW++ SCORE_ALL++ ENDOF                 ASCII 1 OF S_man    I MAN_X ! J MAN_Y ! ENDOF                   ASCII # OF S_fre_plc  ENDOF                                     ( default ) S_fre_plc SWAP                               ENDCASE I J GF! LOOP LOOP ;                                   -->                                                                                                                                                                                             ( вывод спрайта                                      03/23/91 ) : SPRITE_OUT ( n --- )                                            CASE                                                              S_fre_plc     OF ."   " ENDOF                                   Sb_fre_plc    OF ." . " ENDOF                                   S_wall        OF 178 EMIT 178 EMIT ENDOF                        Sb_wall       OF 178 EMIT 178 EMIT ENDOF                        S_man         OF ." ><" ENDOF                                   Sb_man        OF ." ><" ENDOF                                   S_box         OF ." <>" ENDOF                                   Sb_box        OF 17  EMIT 16  EMIT ENDOF                      ENDCASE ;                                                     -->                                                                                                                                                                                                                                                             ( системный вывод спрайта                            03/23/91 ) : SPRITE_SHOW ( x y t --- )                                       >R 2DUP GF@ Sb_box = IF                                           R> DUP >R S_box <> IF SCORE_NEW-- THEN THEN                   2DUP GF@ C_ctrl_bit AND 0 <> IF                                   R> DUP >R S_box  = IF SCORE_NEW++ THEN THEN                   2DUP GF DUP C@ C_ctrl_bit AND R> OR DUP >R SWAP C!                                                                              GOTO_XY R> SPRITE_OUT ;                                                                                                       : GF_SHOW ( --- )                                                 GF_row 0 DO GF_col 0 DO I J 2DUP GF@ SPRITE_SHOW LOOP LOOP ;                                                                  -->                                                                                                                                                                                             ( слово MOVING - изюминка нашего дела                03/23/91 ) : MOVING ( dlt_x dlt_y --- ) 2DUP                                 >R MAN_X @ + R> MAN_Y @ + GF@ C_bit_mask AND S_fre_plc =        IF   >R MAN_X @ + MAN_X ! R> MAN_Y @ + MAN_Y !                  ELSE 2DUP                                                            >R MAN_X @ + R> MAN_Y @ + GF@ C_bit_mask AND S_box =            IF 2DUP >R 2 * MAN_X @ + R> 2 * MAN_Y @ +                          GF@ C_bit_mask AND S_fre_plc =                                  IF   2DUP >R MAN_X @ + R> MAN_Y @ + S_fre_plc                        SPRITE_SHOW                                                     2DUP >R 2 * MAN_X @ + R> 2 * MAN_Y @ + S_box                    SPRITE_SHOW                                                     >R MAN_X @ + MAN_X ! R> MAN_Y @ + MAN_Y !                  ELSE 2DROP THEN                                              ELSE 2DROP THEN                                            THEN ;   -->                                                  ( основной цикл игры                                 03/23/91 ) : GAME_ROUND ( --- )                                              BEGIN                                                             MAN_X @ MAN_Y @ S_man     SPRITE_SHOW                           GETKEY KBRD_KEY !                                               MAN_X @ MAN_Y @ S_fre_plc SPRITE_SHOW                           KBRD_KEY @ CASE                                                            F_Left  OF -1 0 MOVING ENDOF                                    F_Right OF  1 0 MOVING ENDOF                                    F_Up    OF 0 -1 MOVING ENDOF                                    F_Down  OF 0  1 MOVING ENDOF                                 ENDCASE                                               SCORE_NEW @ SCORE_ALL @ =                                          KBRD_KEY @ F_esc =                                              KBRD_KEY @ F_restart = OR OR UNTIL ;                       -->                                                             ( запуск игры и раздача слоников                     03/23/91 ) : GAME_PUSHER ( --- )                                           GF_CONVERT                                                      GF_SHOW       BELL BELL                                                                                                         GAME_ROUND                                                                                                                      10 17 GOTO_XY BELL BELL BELL                                    SCORE_NEW @ SCORE_ALL @ =                                       IF    ." МАЛАДЕЦ "                                              ELSE  ." СЛАББАК "                                              THEN                                                            10 19 GOTO_XY ;                                                                                                                 GAME_PUSHER ( ...поехали! )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     